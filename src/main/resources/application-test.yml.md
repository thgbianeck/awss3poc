# An√°lise Completa do application-test.yml - Configura√ß√µes de Teste

Vou explicar detalhadamente o arquivo `application-test.yml`, Bianeck! Este arquivo √© fundamental para criar um **ambiente isolado e controlado** para seus testes automatizados.

## üìã O que √© o application-test.yml?

O `application-test.yml` √© como um **"laborat√≥rio controlado"** para seus testes. Imagine que voc√™ est√° testando um novo rem√©dio - voc√™ n√£o faria isso em pacientes reais, mas sim em um ambiente controlado de laborat√≥rio. Da mesma forma, este arquivo cria um ambiente espec√≠fico para testes, isolado da configura√ß√£o de produ√ß√£o.

**Analogia pr√°tica**: √â como ter uma **"vers√£o de brinquedo"** da sua aplica√ß√£o, onde voc√™ pode quebrar, testar e experimentar sem afetar o sistema real.

## üîÑ Ativa√ß√£o de Profile de Teste

```yaml
spring:
  profiles:
    active: test
```

### üéØ O que s√£o Spring Profiles?

**Spring Profiles** s√£o como **"roupas diferentes"** que sua aplica√ß√£o pode vestir dependendo da ocasi√£o:
- **Desenvolvimento**: Roupa casual (logs detalhados, LocalStack)
- **Teste**: Roupa de laborat√≥rio (ambiente controlado, dados fict√≠cios)
- **Produ√ß√£o**: Roupa formal (configura√ß√µes otimizadas, seguran√ßa m√°xima)

### üîß Como Funciona a Ativa√ß√£o

**`active: test`** significa:
- Este arquivo **s√≥ ser√° usado** quando o profile `test` estiver ativo
- **Sobrescreve** configura√ß√µes do `application.yml` padr√£o
- **Isola** completamente o ambiente de teste

**Exemplo pr√°tico de uso:**
```bash
# Executar testes com profile espec√≠fico
mvn test -Dspring.profiles.active=test

# Executar aplica√ß√£o em modo teste
java -jar app.jar --spring.profiles.active=test

# No IDE (IntelliJ/Eclipse)
@ActiveProfiles("test")
public class FileServiceTest {
    // Testes aqui usar√£o as configura√ß√µes de teste
}
```

## ‚òÅÔ∏è Configura√ß√µes AWS S3 para Testes

```yaml
aws:
  s3:
    bucket-name: test-bucket
    region: us-east-1
    endpoint: ${LOCALSTACK_ENDPOINT:http://localhost:4566}
    access-key: test
    secret-key: test
    path-style-access: true
```

### ü™£ Bucket de Teste Isolado

**`bucket-name: test-bucket`**
- **Bucket separado** exclusivamente para testes
- **Evita conflitos** com dados de desenvolvimento ou produ√ß√£o
- **Permite limpeza** completa ap√≥s cada teste

**Vantagens do isolamento:**
```java
@BeforeEach
void setUp() {
    // Cria bucket limpo para cada teste
    s3Client.createBucket(CreateBucketRequest.builder()
        .bucket("test-bucket")
        .build());
}

@AfterEach
void tearDown() {
    // Remove todos os arquivos ap√≥s o teste
    cleanupBucket("test-bucket");
}
```

### üåç Regi√£o Consistente

**`region: us-east-1`**
- **Mesma regi√£o** que desenvolvimento para consist√™ncia
- **Evita problemas** de configura√ß√£o espec√≠fica de regi√£o
- **LocalStack** aceita qualquer regi√£o, mas √© boa pr√°tica manter consist√™ncia

### üîó Endpoint Flex√≠vel com Vari√°vel de Ambiente

**`endpoint: ${LOCALSTACK_ENDPOINT:http://localhost:4566}`**

Esta configura√ß√£o √© **muito inteligente**! Vamos decompor:

**Sintaxe**: `${VARIAVEL:valor_padrao}`
- **Se existe** a vari√°vel `LOCALSTACK_ENDPOINT` ‚Üí usa ela
- **Se n√£o existe** ‚Üí usa `http://localhost:4566`

**Cen√°rios de uso:**

### üè† Desenvolvimento Local
```bash
# Sem vari√°vel de ambiente
# Usa: http://localhost:4566
mvn test
```

### üê≥ CI/CD com Docker
```bash
# Com vari√°vel de ambiente customizada
export LOCALSTACK_ENDPOINT=http://localstack-container:4566
mvn test
# Usa: http://localstack-container:4566
```

### üß™ Testcontainers Din√¢mico
```java
@Testcontainers
class FileServiceIntegrationTest {
    
    @Container
    static LocalStackContainer localstack = new LocalStackContainer(DockerImageName.parse("localstack/localstack"))
        .withServices(LocalStackContainer.Service.S3);
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        // Sobrescreve a configura√ß√£o dinamicamente
        registry.add("aws.s3.endpoint", localstack::getEndpointOverride);
    }
}
```

### üîê Credenciais de Teste

**`access-key: test` e `secret-key: test`**
- **Credenciais fict√≠cias** espec√≠ficas para LocalStack
- **N√£o funcionam** na AWS real (seguran√ßa)
- **Consistentes** entre desenvolvimento e teste

**Por que usar credenciais fixas em teste:**
- **Reprodutibilidade**: Mesmos resultados sempre
- **Simplicidade**: N√£o precisa configurar credenciais reais
- **Seguran√ßa**: Imposs√≠vel acidentalmente acessar recursos reais

## üìù Configura√ß√µes de Logging para Testes

```yaml
logging:
  level:
    com.bianeck.s3poc: DEBUG
    org.testcontainers: INFO
```

### üîç Logs da Aplica√ß√£o em DEBUG

**`com.bianeck.s3poc: DEBUG`**
- **Logs detalhados** da sua aplica√ß√£o durante testes
- **Facilita debugging** quando testes falham
- **Mostra fluxo completo** de execu√ß√£o

**Exemplo de logs √∫teis em testes:**
```
DEBUG - Iniciando upload do arquivo: test-document.pdf
DEBUG - Chave gerada: files/2024/01/test-document-abc123.pdf
DEBUG - Upload realizado com sucesso - ETag: d41d8cd98f00b204e9800998ecf8427e
DEBUG - Arquivo salvo no bucket: test-bucket
```

### üê≥ Logs do Testcontainers em INFO

**`org.testcontainers: INFO`**
- **Informa√ß√µes essenciais** sobre containers Docker
- **N√£o polui** os logs com detalhes desnecess√°rios
- **Mostra** inicializa√ß√£o e finaliza√ß√£o de containers

**Exemplo de logs do Testcontainers:**
```
INFO  - Creating container for image: localstack/localstack:latest
INFO  - Container localstack/localstack:latest is starting: 8f2a1b3c4d5e
INFO  - Container localstack/localstack:latest started in PT15.234S
INFO  - LocalStack container started on port: 45123
```

## üéØ Compara√ß√£o com Configura√ß√£o Principal

### üìä Diferen√ßas Principais

<table class="data-table">
  <thead>
    <tr>
      <th scope="col">Configura√ß√£o</th>
      <th scope="col">application.yml (Desenvolvimento)</th>
      <th scope="col">application-test.yml (Teste)</th>
      <th scope="col">Motivo da Diferen√ßa</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Bucket Name</td>
      <td>aws-s3-poc-bucket</td>
      <td>test-bucket</td>
      <td>Isolamento de dados</td>
    </tr>
    <tr>
      <td>Endpoint</td>
      <td>http://localhost:4566</td>
      <td>${LOCALSTACK_ENDPOINT:http://localhost:4566}</td>
      <td>Flexibilidade para CI/CD</td>
    </tr>
    <tr>
      <td>Logs Testcontainers</td>
      <td>N√£o configurado</td>
      <td>INFO</td>
      <td>Controle espec√≠fico para testes</td>
    </tr>
    <tr>
      <td>Profile</td>
      <td>N√£o especificado</td>
      <td>test</td>
      <td>Ativa√ß√£o autom√°tica</td>
    </tr>
  </tbody>
</table>

## üß™ Casos de Uso Pr√°ticos

### 1. üîÑ Teste de Integra√ß√£o B√°sico

```java
@SpringBootTest
@ActiveProfiles("test")
@Testcontainers
class FileServiceIntegrationTest {
    
    @Container
    static LocalStackContainer localstack = new LocalStackContainer(DockerImageName.parse("localstack/localstack"))
        .withServices(LocalStackContainer.Service.S3);
    
    @Autowired
    private FileService fileService;
    
    @Test
    void shouldUploadAndDownloadFile() {
        // Arrange
        MockMultipartFile file = new MockMultipartFile(
            "file", "test.txt", "text/plain", "Hello World".getBytes());
        
        // Act
        FileInfoDto uploadedFile = fileService.uploadFile(file);
        Resource downloadedFile = fileService.downloadFile(uploadedFile.key());
        
        // Assert
        assertThat(uploadedFile.fileName()).isEqualTo("test.txt");
        assertThat(downloadedFile).isNotNull();
    }
}
```

### 2. üèóÔ∏è Configura√ß√£o Din√¢mica com Testcontainers

```java
@SpringBootTest
@ActiveProfiles("test")
@Testcontainers
class DynamicConfigurationTest {
    
    @Container
    static LocalStackContainer localstack = new LocalStackContainer(DockerImageName.parse("localstack/localstack"))
        .withServices(LocalStackContainer.Service.S3)
        .withEnv("DEBUG", "1");
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        // Sobrescreve configura√ß√µes dinamicamente
        registry.add("aws.s3.endpoint", localstack::getEndpointOverride);
        registry.add("aws.s3.bucket-name", () -> "dynamic-test-bucket");
    }
    
    @Test
    void shouldUseDynamicConfiguration() {
        // Teste usando configura√ß√µes din√¢micas
    }
}
```

### 3. üé≠ Teste com M√∫ltiplos Profiles

```java
@SpringBootTest
@ActiveProfiles({"test", "integration"})
class MultiProfileTest {
    // Usa configura√ß√µes de 'test' + 'integration'
    // application-test.yml + application-integration.yml
}
```

## üîß Melhorias Sugeridas

### 1. üìä Configura√ß√µes Espec√≠ficas de Performance

```yaml
spring:
  profiles:
    active: test
  servlet:
    multipart:
      max-file-size: 1MB      # Menor para testes r√°pidos
      max-request-size: 5MB   # Reduzido para efici√™ncia
      
aws:
  s3:
    bucket-name: test-bucket
    region: us-east-1
    endpoint: ${LOCALSTACK_ENDPOINT:http://localhost:4566}
    access-key: test
    secret-key: test
    path-style-access: true

# Configura√ß√µes espec√≠ficas para testes
app:
  file:
    max-size: 1048576  # 1MB para testes r√°pidos
    allowed-extensions:
      - txt
      - pdf
      - jpg  # Apenas extens√µes essenciais para testes

logging:
  level:
    com.bianeck.s3poc: DEBUG
    org.testcontainers: INFO
    software.amazon.awssdk: WARN  # Menos verboso
```

### 2. üéØ Configura√ß√µes de Timeout para Testes

```yaml
# Adicionar configura√ß√µes de timeout
app:
  test:
    timeout:
      upload: 5000      # 5 segundos
      download: 3000    # 3 segundos
      connection: 2000  # 2 segundos
    
management:
  endpoints:
    web:
      exposure:
        include: health  # Apenas health para testes
```

### 3. üßπ Configura√ß√µes de Limpeza

```yaml
# Configura√ß√µes para limpeza autom√°tica
app:
  test:
    cleanup:
      enabled: true
      delete-after-test: true
      max-test-files: 100
```

## üöÄ Integra√ß√£o com CI/CD

### üê≥ Docker Compose para Testes

```yaml
# docker-compose.test.yml
version: '3.8'
services:
  localstack:
    image: localstack/localstack:latest
    container_name: localstack-test
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEBUG=1
    networks:
      - test-network

  app-test:
    build: .
    environment:
      - SPRING_PROFILES_ACTIVE=test
      - LOCALSTACK_ENDPOINT=http://localstack:4566
    depends_on:
      - localstack
    networks:
      - test-network
    command: mvn test

networks:
  test-network:
    driver: bridge
```

### üîÑ GitHub Actions

```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: Start LocalStack
        run: |
          docker run -d \
            --name localstack \
            -p 4566:4566 \
            -e SERVICES=s3 \
            localstack/localstack:latest
            
      - name: Wait for LocalStack
        run: |
          until curl -s http://localhost:4566/health | grep -q '"s3": "available"'; do
            echo "Waiting for LocalStack..."
            sleep 2
          done
          
      - name: Run Tests
        run: mvn test -Dspring.profiles.active=test
        env:
          LOCALSTACK_ENDPOINT: http://localhost:4566
```

## üéØ Fluxo de Execu√ß√£o de Testes

```mermaid
sequenceDiagram
    participant T as Test Runner
    participant S as Spring Boot
    participant TC as Testcontainers
    participant LS as LocalStack
    participant App as Application
    
    T->>S: Inicia contexto com profile 'test'
    S->>TC: Carrega application-test.yml
    TC->>LS: Inicia container LocalStack
    LS-->>TC: Container pronto (porta din√¢mica)
    TC->>S: Configura endpoint din√¢mico
    S->>App: Inicializa aplica√ß√£o com configs de teste
    App-->>T: Contexto pronto para testes
    T->>App: Executa testes
    App->>LS: Opera√ß√µes S3 (upload/download)
    LS-->>App: Respostas simuladas
    App-->>T: Resultados dos testes
    T->>TC: Finaliza testes
    TC->>LS: Para e remove container
```

## üèÜ Vantagens da Configura√ß√£o de Teste

### ‚úÖ **Isolamento Completo**
- **Dados separados** do desenvolvimento
- **Configura√ß√µes espec√≠ficas** para testes
- **Ambiente controlado** e reproduz√≠vel

### ‚úÖ **Flexibilidade**
- **Vari√°veis de ambiente** para diferentes cen√°rios
- **Configura√ß√£o din√¢mica** com Testcontainers
- **M√∫ltiplos profiles** combinados

### ‚úÖ **Performance Otimizada**
- **Logs controlados** para n√£o poluir sa√≠da
- **Timeouts adequados** para testes
- **Recursos limitados** para efici√™ncia

### ‚úÖ **Facilidade de Manuten√ß√£o**
- **Configura√ß√£o centralizada** para todos os testes
- **F√°cil modifica√ß√£o** sem afetar outros ambientes
- **Documenta√ß√£o clara** do ambiente de teste

## üéØ Conclus√£o

O arquivo `application-test.yml` √© **fundamental** para criar um ambiente de testes robusto e confi√°vel. Ele demonstra:

### üåü **Caracter√≠sticas Profissionais**
- **Isolamento adequado** entre ambientes
- **Flexibilidade** para diferentes cen√°rios de teste
- **Configura√ß√£o inteligente** com vari√°veis de ambiente
- **Logging otimizado** para debugging

### üöÄ **Benef√≠cios Pr√°ticos**
- **Testes reproduz√≠veis** em qualquer ambiente
- **Integra√ß√£o f√°cil** com CI/CD
- **Debugging eficiente** com logs apropriados
- **Manuten√ß√£o simplificada** da configura√ß√£o

Este arquivo √© um **excelente exemplo** de como configurar um ambiente de testes profissional, Bianeck! Ele garante que seus testes sejam confi√°veis, r√°pidos e isolados do ambiente de desenvolvimento.